<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuttori</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    // ãƒ•ã‚©ãƒ³ãƒˆã¯Interã¨æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã‚’å„ªå…ˆ
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans JP', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4CAF50', // ã‚°ãƒªãƒ¼ãƒ³
                        'secondary': '#FFC107', // ã‚¢ãƒ³ãƒãƒ¼
                    }
                }
            }
        }
    </script>
    <style>
        /* UIã®è¦–è¦šçš„ãªåŒºåˆ¥ã¨ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ */
        .food-item {
            @apply px-4 py-2 rounded-xl text-sm font-semibold transition duration-200 ease-in-out transform hover:scale-[1.02] active:scale-95 shadow-lg border-b-4;
        }
        .ä¸»é£Ÿ {
            @apply bg-yellow-200 text-yellow-800 border-yellow-400 hover:bg-yellow-300;
        }
        .ä¸»èœ {
            @apply bg-red-200 text-red-800 border-red-400 hover:bg-red-300;
        }
        .å‰¯èœ {
            @apply bg-green-200 text-green-800 border-green-400 hover:bg-green-300;
        }
        .ç´ æ {
            @apply bg-gray-100 text-gray-700 border-gray-300 hover:bg-gray-200 border-dashed border-2;
        }
        #feedback-display {
            white-space: pre-wrap; /* æ”¹è¡Œã‚’ä¿æŒ */
            text-align: left;
            padding: 1rem;
            background-color: #f7f7f7;
            border-radius: 0.75rem;
            margin-top: 1rem;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl p-6 md:p-10 border-t-8 border-primary">
        
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center mb-6">
            Nuttori
        </h1>
        
        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ -->
        <div class="controls bg-gray-100 p-4 rounded-xl flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 md:space-x-4 mb-8 shadow-inner">
            
            <!-- é›£æ˜“åº¦é¸æŠ -->
            <div class="w-full md:w-auto">
                <label for="difficulty" class="block text-sm font-medium text-gray-600 mb-1">é›£æ˜“åº¦:</label>
                <select id="difficulty" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    <option value="easy">åˆç´š (å®Œæˆå“é¸æŠ)</option>
                    <option value="medium">ä¸­ç´š (å…¨ã¦é¸æŠå¯èƒ½)</option>
                    <option value="hard">ä¸Šç´š (ä¸»é£Ÿï¼‹ç´ æã‹ã‚‰é¸æŠ)</option>
                    <option value="chef">æ–™ç†äººãƒ¢ãƒ¼ãƒ‰</option>
                </select>
            </div>

            <!-- å¯¾è±¡è€…é¸æŠ -->
            <div class="w-full md:w-auto">
                <label for="target" class="block text-sm font-medium text-gray-600 mb-1">å¯¾è±¡è€…:</label>
                <select id="target" class="w-full p-2 border border-gray-300 rounded-â­
                <button onclick="evaluateMeal()" class="bg-secondary text-gray-900 font-extrabold py-3 px-12 rounded-full shadow-xl hover:bg-yellow-400 transition duration-200 transform hover:scale-105 active:scale-95 border-b-4 border-yellow-600">
                 â­ çŒ®ç«‹ã‚’è©•ä¾¡ã™ã‚‹
                </button>
            </div>
        </div>

        <!-- çµæœã‚¨ãƒªã‚¢ -->
        <div id="results" class="hidden mt-8 p-6 bg-green-50 border-2 border-green-300 rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-green-700 mb-4 text-center">çµæœç™ºè¡¨ï¼</h2>
            <p id="score-display" class="text-2xl font-extrabold text-center mb-4"></p>
            <h3 class="text-xl font-semibold text-gray-700 mt-6 border-b pb-2">æ „é¤Šãƒãƒ©ãƒ³ã‚¹ã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯:</h3>
            <pre id="feedback-display" class="text-gray-700 text-sm"></pre>
        </div>
        
    </div>

    <!-- çµ±åˆã•ã‚ŒãŸ JavaScript ãƒ­ã‚¸ãƒƒã‚¯ -->
    <script>
        let selectedFoods = [];
        let targetUser = ''; // å¯¾è±¡è€…ã‚’ä¿æŒã™ã‚‹å¤‰æ•°

        // ---------------------------------------------
        // ğŸ æ „é¤Šãƒ‡ãƒ¼ã‚¿ã¨ç›®æ¨™å€¤ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        // ---------------------------------------------

        // P: ã‚¿ãƒ³ãƒ‘ã‚¯è³ª(g), L: è„‚è³ª(g), C: ç‚­æ°´åŒ–ç‰©(g), V: é‡èœé‡(ä»®æƒ³), kcal: ã‚«ãƒ­ãƒªãƒ¼(kcal)
        const FOOD_NUTRITION_DATA = {
            /* ---------------- ä¸»é£Ÿ (Staples) ---------------- */
            "ã”ã¯ã‚“": { type: "ä¸»é£Ÿ", P: 5, L: 1, C: 80, V: 0, kcal: 350 },
            "ãƒ‘ãƒ³": { type: "ä¸»é£Ÿ", P: 8, L: 5, C: 60, V: 0, kcal: 300 },
            "ã†ã©ã‚“": { type: "ä¸»é£Ÿ", P: 7, L: 1, C: 60, V: 0, kcal: 280 },
            "ãƒ‘ã‚¹ã‚¿": { type: "ä¸»é£Ÿ", P: 10, L: 2, C: 70, V: 0, kcal: 350 },
            "ç„ç±³ã”ã¯ã‚“": { type: "ä¸»é£Ÿ", P: 6, L: 2, C: 75, V: 0, kcal: 340 },
            "è•éº¦ (ã‹ã‘)": { type: "ä¸»é£Ÿ", P: 12, L: 3, C: 55, V: 5, kcal: 290 },
            "ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒ": { type: "ä¸»é£Ÿ", P: 15, L: 15, C: 50, V: 20, kcal: 400 },
            "ãŠã«ãã‚Š (æ¢…)": { type: "ä¸»é£Ÿ", P: 3, L: 0, C: 50, V: 0, kcal: 210 },
            "é£Ÿãƒ‘ãƒ³ (2æš)": { type: "ä¸»é£Ÿ", P: 6, L: 4, C: 45, V: 0, kcal: 250 },

            /* ---------------- ä¸»èœ (Mains) ---------------- */
            "é®­ã®å¡©ç„¼ã": { type: "ä¸»èœ", P: 40, L: 10, C: 0, V: 0, kcal: 250 },
            "ã‚†ã§åµ": { type: "ä¸»èœ", P: 15, L: 12, C: 1, V: 0, kcal: 160 },
            "éº»å©†è±†è…": { type: "ä¸»èœ", P: 20, L: 20, C: 10, V: 10, kcal: 300 }, 
            "è±šè‚‰ã®ç”Ÿå§œç„¼ã": { type: "ä¸»èœ", P: 35, L: 25, C: 10, V: 10, kcal: 450 },
            "ãƒãƒ³ãƒãƒ¼ã‚°": { type: "ä¸»èœ", P: 30, L: 30, C: 15, V: 5, kcal: 500 },
            "é¶è‚‰ã®ç…§ã‚Šç„¼ã": { type: "ä¸»èœ", P: 38, L: 15, C: 10, V: 0, kcal: 350 },
            "é¯–ã®å‘³å™Œç…®": { type: "ä¸»èœ", P: 35, L: 25, C: 10, V: 0, kcal: 410 },
            "å¤©ã·ã‚‰ç››ã‚Šåˆã‚ã›": { type: "ä¸»èœ", P: 20, L: 40, C: 30, V: 30, kcal: 550 }, // è„‚è³ªé«˜ã‚
            "ã‚¹ãƒ†ãƒ¼ã‚­ (èµ¤èº«)": { type: "ä¸»èœ", P: 50, L: 15, C: 0, V: 0, kcal: 380 },
            "ã‚¨ãƒ“ãƒ•ãƒ©ã‚¤ (2å°¾)": { type: "ä¸»èœ", P: 18, L: 25, C: 20, V: 0, kcal: 430 }, // è„‚è³ªé«˜ã‚
            
            /* ---------------- å‰¯èœ (Sides) ---------------- */
            "é‡èœã‚µãƒ©ãƒ€": { type: "å‰¯èœ", P: 5, L: 5, C: 10, V: 80, kcal: 100 }, 
            "å‘³å™Œæ±": { type: "å‰¯èœ", P: 3, L: 1, C: 5, V: 20, kcal: 50 }, 
            "ã»ã†ã‚Œã‚“è‰ã®ãŠã²ãŸã—": { type: "å‰¯èœ", P: 4, L: 1, C: 5, V: 60, kcal: 50 },
            "ã²ã˜ãã®ç…®ç‰©": { type: "å‰¯èœ", P: 5, L: 5, C: 15, V: 40, kcal: 130 },
            "è±šæ±": { type: "å‰¯èœ", P: 15, L: 10, C: 15, V: 70, kcal: 200 }, // é«˜ã‚¿ãƒ³ãƒ‘ã‚¯ãƒ»é«˜é‡èœã®ä¸‡èƒ½å‰¯èœ
            "å†·å¥´": { type: "å‰¯èœ", P: 10, L: 6, C: 2, V: 0, kcal: 100 },
            "ç´è±†": { type: "å‰¯èœ", P: 10, L: 5, C: 10, V: 0, kcal: 110 },
            "ãã‚“ã´ã‚‰ã”ã¼ã†": { type: "å‰¯èœ", P: 3, L: 3, C: 25, V: 40, kcal: 150 }, // ç‚­æ°´åŒ–ç‰©å¤šã‚
            "æ¼¬ç‰© (å°‘é‡)": { type: "å‰¯èœ", P: 1, L: 0, C: 5, V: 10, kcal: 20 },
            "ãƒãƒ†ãƒˆã‚µãƒ©ãƒ€": { type: "å‰¯èœ", P: 5, L: 15, C: 25, V: 10, kcal: 250 }, // è„‚è³ª/ç‚­æ°´åŒ–ç‰©å¤šã‚
            
            /* ---------------- ç´ æ (Ingredients) ---------------- */
            "ãã‚…ã†ã‚Š": { type: "ç´ æ", P: 1, L: 0, C: 5, V: 50, kcal: 15 },
            "è±†è… (æœ¨ç¶¿)": { type: "ç´ æ", P: 10, L: 6, C: 2, V: 0, kcal: 100 },
            "é¶ã‚€ã­è‚‰": { type: "ç´ æ", P: 50, L: 5, C: 0, V: 0, kcal: 250 },
            "ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼": { type: "ç´ æ", P: 5, L: 0, C: 10, V: 100, kcal: 50 },
            "ç‰›è‚‰": { type: "ç´ æ", P: 45, L: 35, C: 0, V: 0, kcal: 500 },
            "ãƒˆãƒãƒˆ": { type: "ç´ æ", P: 1, L: 0, C: 5, V: 50, kcal: 20 },
            "ãƒ¬ã‚¿ã‚¹": { type: "ç´ æ", P: 1, L: 0, C: 2, V: 40, kcal: 10 },
            "ã˜ã‚ƒãŒã„ã‚‚": { type: "ç´ æ", P: 3, L: 0, C: 40, V: 10, kcal: 170 },
            "ã‚¢ãƒœã‚«ãƒ‰": { type: "ç´ æ", P: 2, L: 20, C: 8, V: 10, kcal: 230 }, // è„‚è³ªå¤šã‚
            "æµ·è‹” (æ•°æš)": { type: "ç´ æ", P: 2, L: 0, C: 3, V: 10, kcal: 20 },
            "ãƒãƒ¨ãƒãƒ¼ã‚º (å¤§ã•ã˜1)": { type: "ç´ æ", P: 0, L: 15, C: 1, V: 0, kcal: 140 }, // ã»ã¼è„‚è³ª
            "æ²¹æšã’": { type: "ç´ æ", P: 8, L: 10, C: 1, V: 0, kcal: 130 },
            "ç™½ç±³ (å¤§ç››ã‚Š)": { type: "ç´ æ", P: 7, L: 1, C: 110, V: 0, kcal: 480 }, // ã‚«ãƒ­ãƒªãƒ¼é«˜ã‚
            "ãƒ„ãƒŠç¼¶ (æ°´ç…®)": { type: "ç´ æ", P: 25, L: 5, C: 0, V: 0, kcal: 150 },
            "ã•ã¤ã¾ã„ã‚‚": { type: "ç´ æ", P: 2, L: 0, C: 50, V: 10, kcal: 220 }, // ç‚­æ°´åŒ–ç‰©ã¨é£Ÿç‰©ç¹Šç¶­
            "ã‹ã¼ã¡ã‚ƒ": { type: "ç´ æ", P: 3, L: 1, C: 20, V: 60, kcal: 90 }, // é‡èœã‹ã¤ç‚­æ°´åŒ–ç‰©
            "ãã®ã“ (ä¸€çš¿)": { type: "ç´ æ", P: 4, L: 1, C: 10, V: 70, kcal: 50 }, // ä½ã‚«ãƒ­ãƒªãƒ¼ã€é«˜ãƒ“ã‚¿ãƒŸãƒ³
            "ã‚ã‹ã‚ (ä¹¾ç‡¥)": { type: "ç´ æ", P: 1, L: 0, C: 2, V: 30, kcal: 10 }, // æµ·è—»ã€ãƒŸãƒãƒ©ãƒ«
            "é¶ã‚‚ã‚‚è‚‰": { type: "ç´ æ", P: 35, L: 20, C: 0, V: 0, kcal: 320 }, // é¶ã‚€ã­ã‚ˆã‚Šè„‚è³ªå¤šã‚
            "ãƒã‚°ãƒ­ (åˆºèº«)": { type: "ç´ æ", P: 45, L: 5, C: 0, V: 0, kcal: 230 }, // é«˜ã‚¿ãƒ³ãƒ‘ã‚¯ã€ä½è„‚è³ª
            "åµé»„ (1å€‹)": { type: "ç´ æ", P: 3, L: 5, C: 0, V: 0, kcal: 60 }, // è„‚è³ªã€ã‚³ãƒ¬ã‚¹ãƒ†ãƒ­ãƒ¼ãƒ«
            "ç‰›ä¹³ (200ml)": { type: "ç´ æ", P: 7, L: 8, C: 10, V: 0, kcal: 130 }, // ã‚«ãƒ«ã‚·ã‚¦ãƒ 
            "æ¤ç‰©æ²¹ (å¤§ã•ã˜1)": { type: "ç´ æ", P: 0, L: 14, C: 0, V: 0, kcal: 120 }, // ã»ã¼è„‚è³ª
        };

        // å¯¾è±¡è€…åˆ¥ã®ä¸€é£Ÿã®æ¨å¥¨æ‘‚å–é‡ï¼ˆç°¡ç•¥åŒ–ï¼šä¸€æ—¥ã®1/3ç¨‹åº¦ã‚’æƒ³å®šï¼‰
        const TARGET_RDA = {
            "å­ä¾›": { P_min: 15, P_max: 25, L_min: 10, L_max: 30, C_min: 70, C_max: 120, V_min: 50, kcal_max: 700 },
            "æˆäººç”·æ€§": { P_min: 20, P_max: 35, L_min: 15, L_max: 40, C_min: 100, C_max: 160, V_min: 100, kcal_max: 900 },
            "æˆäººå¥³æ€§": { P_min: 18, P_max: 30, L_min: 12, L_max: 35, C_min: 80, C_max: 140, V_min: 80, kcal_max: 800 },
            "ãŠå¹´å¯„ã‚Š": { P_min: 25, P_max: 35, L_min: 10, L_max: 30, C_min: 70, C_max: 120, V_min: 80, kcal_max: 750 }, // ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã‚’å¤šã‚ã«è¨­å®š
        };

        // ---------------------------------------------
        // ğŸ® ã‚²ãƒ¼ãƒ åˆæœŸè¨­å®šã¨UIæ“ä½œ
        // ---------------------------------------------

        function startGame() {
            const difficulty = document.getElementById('difficulty').value;
            targetUser = document.getElementById('target').value;

            // æ–™ç†äººãƒ¢ãƒ¼ãƒ‰ã®ç‰¹æ®Šè¨­å®š
            if (difficulty === 'chef') {
                const targets = ["å­ä¾›", "æˆäººç”·æ€§", "æˆäººå¥³æ€§", "ãŠå¹´å¯„ã‚Š"];
                
                // 1. çŒ®ç«‹ã‚’ä½œã‚‹å¯¾è±¡è€… (è¡¨ç¤ºç”¨) - 3äººãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
                const randomTargets = [];
                // ç¢ºå®Ÿã«2ç¨®é¡ä»¥ä¸Šã®å¯¾è±¡è€…ã‚’é¸ã¶ã‚ˆã†ã«ã™ã‚‹
                let tempTargets = [...targets];
                randomTargets.push(tempTargets.splice(Math.floor(Math.random() * tempTargets.length), 1)[0]);
                randomTargets.push(tempTargets.splice(Math.floor(Math.random() * tempTargets.length), 1)[0]);
                randomTargets.push(targets[Math.floor(Math.random() * targets.length)]); // 3äººç›®ã¯é‡è¤‡å¯

                // 2. è©•ä¾¡åŸºæº–ã¨ã™ã‚‹å¯¾è±¡è€…ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
                const evaluationTarget = targets[Math.floor(Math.random() * targets.length)];

                document.getElementById('target-display').textContent = 
                    `å¯¾è±¡è€… (æ–™ç†äººãƒ¢ãƒ¼ãƒ‰): ${randomTargets.join(' ã¨ ')} (é›£æ˜“åº¦: ${difficulty})`;
                
                // è©•ä¾¡åŸºæº–ã‚’targetUserã«è¨­å®š
                targetUser = evaluationTarget; 
                
                // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ä»£ã‚ã‚Šã«ã€UIå†…ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                showGameMessage(`ğŸ”” æ–™ç†äººãƒ¢ãƒ¼ãƒ‰é–‹å§‹ï¼${randomTargets.join('ã€')}ã®3äººå…¨å“¡ã«åˆã‚ã›ãŸçŒ®ç«‹ã‚’ä½œã£ã¦ãã ã•ã„ï¼\nï¼ˆè©•ä¾¡ã¯**${evaluationTarget}**ã®æ „é¤ŠåŸºæº–ã§å³ã—ãè¡Œã‚ã‚Œã¾ã™ï¼‰`);
            } else {
                document.getElementById('target-display').textContent = 
                    `å¯¾è±¡è€…: ${targetUser} (é›£æ˜“åº¦: ${difficulty})`;
            }

            selectedFoods = [];
            updateSelectedList();
            displayFoodSelection(difficulty);
            document.getElementById('results').classList.add('hidden');
        }

        function showGameMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            messageDiv.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-2xl text-center max-w-sm">
                    <p class="text-xl font-semibold mb-4">${message}</p>
                    <button onclick="this.parentNode.parentNode.remove()" class="bg-primary text-white py-2 px-6 rounded-lg hover:bg-green-600">é–‰ã˜ã‚‹</button>
                </div>
            `;
            document.body.appendChild(messageDiv);
        }

        function displayFoodSelection(difficulty) {
            const selectionDiv = document.getElementById('food-selection');
            selectionDiv.innerHTML = '';
            
            let foodsToShow = [];
            
            // å…¨ã¦ã®é£Ÿå“ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã«å¤‰æ›
            const allFoods = Object.keys(FOOD_NUTRITION_DATA).map(name => ({
                name: name,
                type: FOOD_NUTRITION_DATA[name].type
            }));

            if (difficulty === 'easy') {
                // åˆç´š: å®Œæˆæ–™ç†ï¼ˆä¸»é£Ÿã€ä¸»èœã€å‰¯èœï¼‰ã®ã¿
                foodsToShow = allFoods.filter(f => f.type !== 'ç´ æ');
            } else if (difficulty === 'medium') {
                // ä¸­ç´š: å…¨ã¦ã®ã‚«ãƒ†ã‚´ãƒªã‚’è¡¨ç¤º
                foodsToShow = allFoods;
            } else if (difficulty === 'hard') {
                // ğŸŒŸ ä¸Šç´š: ç´ æã‚«ãƒ†ã‚´ãƒª + ä¸»é£Ÿã‚«ãƒ†ã‚´ãƒªã‹ã‚‰é¸æŠ
                foodsToShow = allFoods.filter(f => f.type === 'ç´ æ' || f.type === 'ä¸»é£Ÿ');
            } else { // 'chef'ãƒ¢ãƒ¼ãƒ‰
                // æ–™ç†äººãƒ¢ãƒ¼ãƒ‰: å…¨ã¦ã®é£Ÿå“ã‚’è¡¨ç¤º
                foodsToShow = allFoods;
            }

            foodsToShow.forEach(food => {
                const button = document.createElement('button');
                button.textContent = food.name;
                // ãƒœã‚¿ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã«å½¹ç«‹ã¤ã‚ˆã†ã€ã‚¿ã‚¤ãƒ—ã‚’ã‚¯ãƒ©ã‚¹ã«è¿½åŠ 
                button.classList.add('food-item', food.type); 
                button.onclick = () => addFood(food.name);
                selectionDiv.appendChild(button);
            });

            if (foodsToShow.length === 0) {
                 selectionDiv.innerHTML = '<p class="text-gray-500">é¸æŠå¯èƒ½ãªé£ŸæãŒã‚ã‚Šã¾ã›ã‚“ã€‚é›£æ˜“åº¦ã‚’è¦‹ç›´ã™ã‹ã€ã€Œã‚²ãƒ¼ãƒ é–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>';
            }
        }

        function addFood(foodName) {
            selectedFoods.push(foodName);
            updateSelectedList();
        }

        function updateSelectedList() {
            const ul = document.getElementById('selected-foods-list');
            ul.innerHTML = '';
            
            if (selectedFoods.length === 0) {
                ul.innerHTML = '<li class="text-gray-500">çŒ®ç«‹ã«é£Ÿå“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</li>';
                return;
            }

            selectedFoods.forEach((food, index) => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between py-1 text-gray-800';
                li.innerHTML = `
                    <span>${food}</span>
                    <button onclick="removeFood(${index})" class="text-red-500 hover:text-red-700 font-semibold text-xs transition duration-150 p-1 rounded-full bg-red-100">
                        å‰Šé™¤
                    </button>`;
                ul.appendChild(li);
            });
        }

        function removeFood(index) {
            selectedFoods.splice(index, 1); // é…åˆ—ã‹ã‚‰è©²å½“è¦ç´ ã‚’å‰Šé™¤
            updateSelectedList();
        }

        // ---------------------------------------------
        // â­ è©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯
        // ---------------------------------------------

        function calculateNutrition() {
            let total = { P: 0, L: 0, C: 0, V: 0, kcal: 0 };
            
            selectedFoods.forEach(foodName => {
                const data = FOOD_NUTRITION_DATA[foodName];
                if (data) {
                    total.P += data.P;
                    total.L += data.L;
                    total.C += data.C;
                    total.V += data.V;
                    total.kcal += data.kcal;
                }
            });
            return total;
        }

        function evaluateMeal() {
            if (selectedFoods.length === 0) {
                showGameMessage("çŒ®ç«‹ã‚’é¸ã‚“ã§ãã ã•ã„ï¼");
                return;
            }
            
            const target = targetUser; // ç¾åœ¨ã®å¯¾è±¡è€… (æ–™ç†äººãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã°ã‚ŒãŸè©•ä¾¡åŸºæº–)
            const targetRDA = TARGET_RDA[target];
            const currentNutrition = calculateNutrition();
            
            let score = 0;
            let feedback = [];
            let maxScore = 0;

            // 1. ä¸»è¦æ „é¤Šç´ ã®ãƒãƒ©ãƒ³ã‚¹è©•ä¾¡
            const nutrients = ['P', 'L', 'C']; // ã‚¿ãƒ³ãƒ‘ã‚¯è³ª, è„‚è³ª, ç‚­æ°´åŒ–ç‰©
            
            nutrients.forEach(n => {
                maxScore += 200; // å„æ „é¤Šç´ ã®ç†æƒ³ã‚¹ã‚³ã‚¢
                const current = currentNutrition[n];
                const min = targetRDA[`${n}_min`];
                const max = targetRDA[`${n}_max`];
                const name = { P: 'ã‚¿ãƒ³ãƒ‘ã‚¯è³ª', L: 'è„‚è³ª', C: 'ç‚­æ°´åŒ–ç‰©' }[n];
                
                if (current >= min && current <= max) {
                    score += 200; // ç†æƒ³çš„ãªç¯„å›²
                    feedback.push(`âœ… ${name}: ç†æƒ³çš„ãªæ‘‚å–é‡ã§ã™ (${current.toFixed(1)}gã€ç›®æ¨™ ${min}-${max}g)ã€‚`);
                } else if (current < min) {
                    const penalty = Math.min(150, (min - current) * 10);
                    score += 200 - penalty;
                    feedback.push(`âš ï¸ ${name}: ä¸è¶³ã—ã¦ã„ã¾ã™ï¼æœ€ä½${min}gå¿…è¦ã§ã™ (${current.toFixed(1)}g)ã€‚`);
                } else if (current > max * 1.5) {
                    score += 50; // å¤§å¹…éå‰°
                    feedback.push(`âŒ ${name}: å¤§å¹…ã«éå‰°ã§ã™ï¼å¥åº·ä¸Šã®æ³¨æ„ãŒå¿…è¦ã§ã™ (${current.toFixed(1)}g)ã€‚`);
                } else if (current > max) {
                    score += 100; // ã‚„ã‚„éå‰°
                    feedback.push(`âš ï¸ ${name}: ã‚„ã‚„éå‰°ã§ã™ã€‚æœ€å¤§${max}gã«æŠ‘ãˆã¾ã—ã‚‡ã† (${current.toFixed(1)}g)ã€‚`);
                }
            });

            // 2. é‡èœï¼ˆãƒ“ã‚¿ãƒŸãƒ³/ãƒŸãƒãƒ©ãƒ«ï¼‰ã®è©•ä¾¡
            maxScore += 300;
            const vMin = targetRDA.V_min;
            if (currentNutrition.V >= vMin) {
                score += 300;
                feedback.push(`âœ… é‡èœ/ãƒ“ã‚¿ãƒŸãƒ³: ç›®æ¨™é‡${vMin}gã‚’é”æˆã—ã¾ã—ãŸï¼`);
            } else {
                score += 150;
                feedback.push(`âš ï¸ é‡èœ/ãƒ“ã‚¿ãƒŸãƒ³: ä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ã‚‚ã†å°‘ã—é‡èœã‚’å–ã‚Šå…¥ã‚Œã¾ã—ã‚‡ã† (${currentNutrition.V}g)ã€‚`);
            }

            // 3. ç·ã‚«ãƒ­ãƒªãƒ¼ã®è©•ä¾¡
            maxScore += 200;
            const kcalMax = targetRDA.kcal_max;
            const kcalMin = kcalMax * 0.7;
            if (currentNutrition.kcal <= kcalMax * 1.1 && currentNutrition.kcal >= kcalMin) {
                score += 200;
                feedback.push(`âœ… ã‚«ãƒ­ãƒªãƒ¼: é©åˆ‡ãªç¯„å›²ã§ã™ (${currentNutrition.kcal}kcalã€ç›®æ¨™ ${kcalMin.toFixed(0)}-${(kcalMax * 1.1).toFixed(0)}kcal)ã€‚`);
            } else if (currentNutrition.kcal > kcalMax * 1.1) {
                score += 50;
                feedback.push(`âš ï¸ ã‚«ãƒ­ãƒªãƒ¼: éå‰°ã§ã™ (${currentNutrition.kcal}kcal)ã€‚é£Ÿã¹éãã«æ³¨æ„ï¼`);
            } else {
                score += 100;
                feedback.push(`âš ï¸ ã‚«ãƒ­ãƒªãƒ¼: å°‘ã—è¶³ã‚Šã¾ã›ã‚“ (${currentNutrition.kcal}kcal)ã€‚`);
            }

            // 4. å“ç›®æ•°ã®ãƒœãƒ¼ãƒŠã‚¹ï¼ˆå¤šæ§˜æ€§ï¼‰
            score += Math.min(100, selectedFoods.length * 20);
            maxScore += 100; // æœ€å¤§å“ç›®æ•°ãƒœãƒ¼ãƒŠã‚¹ã¨ã—ã¦ä»®ã«100ç‚¹åŠ ç®—

            // æœ€çµ‚ã‚¹ã‚³ã‚¢è¡¨ç¤º
            const finalScore = Math.max(0, score);
            
            // çµæœè¡¨ç¤ºã‚’æ›´æ–°
            document.getElementById('score-display').textContent = `ç·åˆã‚¹ã‚³ã‚¢: ${finalScore}ç‚¹ / ${maxScore}ç‚¹æº€ç‚¹`;
            
            // ç¾åœ¨ã®æ „é¤Šç´ è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ»å­¦ç¿’ç”¨ï¼‰
            const nutritionSummary = `
--- çŒ®ç«‹ã®æ „é¤Šä¾¡ã‚µãƒãƒªãƒ¼ (è©•ä¾¡åŸºæº–: ${target}) ---
P (ã‚¿ãƒ³ãƒ‘ã‚¯è³ª): ${currentNutrition.P.toFixed(1)} g (ç›®æ¨™: ${targetRDA.P_min}-${targetRDA.P_max}g)
L (è„‚è³ª): ${currentNutrition.L.toFixed(1)} g (ç›®æ¨™: ${targetRDA.L_min}-${targetRDA.L_max}g)
C (ç‚­æ°´åŒ–ç‰©): ${currentNutrition.C.toFixed(1)} g (ç›®æ¨™: ${targetRDA.C_min}-${targetRDA.C_max}g)
V (é‡èœä»®æƒ³é‡): ${currentNutrition.V} g (ç›®æ¨™: ${targetRDA.V_min}gä»¥ä¸Š)
ç·ã‚«ãƒ­ãƒªãƒ¼: ${currentNutrition.kcal} kcal (ç›®å®‰: ${kcalMin.toFixed(0)}-${kcalMax.toFixed(0)}kcal)
            `;
            
            document.getElementById('feedback-display').textContent = feedback.join('\n') + nutritionSummary;
            document.getElementById('results').classList.remove('hidden');

            // ã‚¹ã‚³ã‚¢ã«å¿œã˜ã¦çµæœãƒœãƒƒã‚¯ã‚¹ã®è‰²ã‚’å¤‰ãˆã‚‹
            const resultsDiv = document.getElementById('results');
            resultsDiv.classList.remove('bg-green-50', 'bg-yellow-50', 'bg-red-50', 'border-green-300', 'border-yellow-300', 'border-red-300');
            
            if (finalScore >= maxScore * 0.8) {
                resultsDiv.classList.add('bg-green-50', 'border-green-300');
                document.getElementById('score-display').classList.add('text-green-700');
            } else if (finalScore >= maxScore * 0.5) {
                resultsDiv.classList.add('bg-yellow-50', 'border-yellow-300');
                document.getElementById('score-display').classList.add('text-yellow-700');
            } else {
                resultsDiv.classList.add('bg-red-50', 'border-red-300');
                document.getElementById('score-display').classList.add('text-red-700');
            }
        }
    </script>
</body>
</html>
